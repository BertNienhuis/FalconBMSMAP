<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Falcon BMS Flat Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.css">
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg" />
    <link rel="shortcut icon" href="images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png" />
    <link rel="manifest" href="images/site.webmanifest" />
</head>

<body>

    <!-- Map & Mouse Position -->
    <div id="map" class="map"></div>
    <div id="mouse-position"></div>



    <!-- Control Bar -->
    <div id="control-wrapper">
        <div id="control-bar" role="complementary" aria-label="Toolbar">
            <div class="tool-group">
                <select id="theater-select" class="glass-select map-select" aria-label="Select theater">
                <option value="Korea">Korea</option>
                <option value="Israel">Israel</option>
                <option value="Balkans">Balkans</option>
            </select>
            <input id="airport-search" type="text" placeholder="Search airports..." />
            <ul id="airport-search-results" class="hidden"></ul>
        </div>
        <div class="tool-group">
            <label class="button file-upload-label" title="Open mission">
                <i data-lucide="folder-open"></i> Open mission
                <input type="file" id="ini-loader" style="display: none;">
            </label>

            <button id="clear-button" class="button" title="Clear mission"><i data-lucide="trash-2"></i> Clear</button>
        </div>

        <div class="tool-group">
            <button id="ruler-button" class="button" title="Measure distance (L)"><i data-lucide="ruler"></i>
                Ruler</button>
            <button id="marker-button" class="button" title="Add marker"><i data-lucide="map-pin"></i> Marker</button>
            <button id="bullseye-button" class="button" title="Move Bullseye"><i data-lucide="crosshair"></i> Bullseye
            </button>
            <button id="whiteboard-toolbar-toggle" class="button" title="Whiteboard tools" aria-controls="whiteboard-toolbar" aria-expanded="false"><i data-lucide="pen-tool"></i> Whiteboard
            </button>
            <button id="pdf-viewer-toggle" class="button" title="Open PDF viewer" aria-controls="pdf-viewer-overlay" aria-expanded="false">
                <i data-lucide="file-text"></i> PDF Viewer
            </button>
        </div>

        <div class="tool-group">
            <div class="tool-group-header">Import / Export</div>
                <label class="button" title="Import layers">
                    <i data-lucide="download"></i> Import layers
                    <input type="file" id="import-layers" accept=".json" style="display: none;">
                </label>
                <button id="export-layers" class="button" title="Export layers">
                    <i data-lucide="upload"></i> Export layers
                </button>
            </div>
        </div>
        <button id="control-toggle" class="floating-toggle floating-toggle--close" title="Hide toolbar" aria-expanded="true" aria-controls="control-bar">
            <i id="control-toggle-icon" class="floating-toggle-icon " data-lucide="x"></i>
        </button>
    </div>
    <button id="control-toggle-open" class="floating-toggle floating-toggle--open" title="Show toolbar" aria-controls="control-bar" aria-expanded="false">
        <i data-lucide="panel-left-open"></i>
    </button>

    <div id="whiteboard-toolbar" class="whiteboard-toolbar overlay-panel" aria-label="Whiteboard tools" aria-hidden="true">
        <button id="whiteboard-toolbar-close" class="floating-toggle floating-toggle--close" title="Close whiteboard tools" aria-label="Close whiteboard toolbar">
            <i data-lucide="x"></i>
        </button>
        <div class="whiteboard-toolset">
            <div class="whiteboard-toolbar-row">
                <div class="whiteboard-button-groups">
                    <div class="whiteboard-draw-group" role="group" aria-label="Whiteboard draw tools">
                        <button id="whiteboard-pencil" class="button whiteboard-button" title="Free draw (Q)">
                            <i data-lucide="pencil"></i>
                            <span class="whiteboard-button-label">Pencil</span>
                            <span class="whiteboard-button-hint">Q</span>
                        </button>
                        <button id="whiteboard-polygon" class="button whiteboard-button" title="Polygon (W)">
                            <i data-lucide="triangle"></i>
                            <span class="whiteboard-button-label">Polygon</span>
                            <span class="whiteboard-button-hint">W</span>
                        </button>
                        <button id="whiteboard-circle" class="button whiteboard-button" title="Circle (E)">
                            <i data-lucide="circle"></i>
                            <span class="whiteboard-button-label">Circle</span>
                            <span class="whiteboard-button-hint">E</span>
                        </button>
                        <button id="whiteboard-rect" class="button whiteboard-button" title="Rectangle (R)">
                            <i data-lucide="square"></i>
                            <span class="whiteboard-button-label">Rectangle</span>
                            <span class="whiteboard-button-hint">R</span>
                        </button>
                        <button id="whiteboard-text" class="button whiteboard-button" title="Text (T)">
                            <i data-lucide="type"></i>
                            <span class="whiteboard-button-label">Text</span>
                            <span class="whiteboard-button-hint">T</span>
                        </button>
                    </div>
                    <div class="whiteboard-edit-group" role="group" aria-label="Whiteboard actions">
                        <button id="whiteboard-undo" class="button whiteboard-button" title="Undo (Z)">
                            <i data-lucide="undo-2"></i>
                            <span class="whiteboard-button-label">Undo</span>
                            <span class="whiteboard-button-hint">Z</span>
                        </button>
                        <button id="whiteboard-redo" class="button whiteboard-button" title="Redo (Y)">
                            <i data-lucide="redo-2"></i>
                            <span class="whiteboard-button-label">Redo</span>
                            <span class="whiteboard-button-hint">Y</span>
                        </button>
                        <button id="whiteboard-eraser" class="button whiteboard-button" title="Clear whiteboard (C)">
                            <i data-lucide="eraser"></i>
                            <span class="whiteboard-button-label">Clean</span>
                            <span class="whiteboard-button-hint">C</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="whiteboard-style-group" aria-label="Whiteboard styles">
                <div class="whiteboard-style-grid compact whiteboard-style-grid--sliders">
                    <label class="whiteboard-style-control whiteboard-style-color" data-role="stroke">
                        <span class="whiteboard-color-picker">
                            <span class="whiteboard-color-swatch" data-role="stroke"></span>
                            <input type="color" id="whiteboard-stroke-color" value="#ff0000" aria-label="Line color">
                        </span>
                    </label>
                    <label class="whiteboard-style-control whiteboard-style-range" for="whiteboard-line-width">
                        <div class="whiteboard-style-header">
                            <span class="whiteboard-style-text">Width</span>
                        </div>
                        <input type="range" id="whiteboard-line-width" min="1" max="10" step="1" value="2" aria-label="Line width">
                    </label>
                    <label class="whiteboard-style-control whiteboard-style-range" for="whiteboard-fill-opacity">
                        <div class="whiteboard-style-header">
                            <span class="whiteboard-style-text">Opacity</span>
                        </div>
                        <input type="range" id="whiteboard-fill-opacity" min="0" max="100" step="5" value="20" aria-label="Fill opacity">
                    </label>
                </div>
                <div class="whiteboard-style-control whiteboard-style-select compact-select">
                    <select id="whiteboard-line-type" class="glass-select" aria-label="Line pattern">
                        <option value="full" selected>Solid line</option>
                        <option value="striped">Striped line</option>
                        <option value="dotted">Dotted line</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Viewer -->
    <div id="pdf-viewer-overlay" class="pdf-viewer overlay-panel" aria-hidden="true" role="dialog" aria-label="PDF viewer overlay">
        <button id="pdf-viewer-close" class="floating-toggle floating-toggle--close" title="Close PDF viewer" aria-label="Close PDF viewer">
            <i data-lucide="x"></i>
        </button>
        <div class="pdf-viewer-controls">
            <label class="button" title="Upload PDF file">
                <i data-lucide="upload-cloud"></i> Upload PDF
                <input type="file" id="pdf-file-input" accept="application/pdf" style="display: none;">
            </label>
            <input id="pdf-url-input" class="glass-input pdf-url-input" type="text" placeholder="Paste PDF URL..." aria-label="PDF URL">
            <button id="pdf-load-button" class="button" title="Load PDF from URL">
                <i data-lucide="link-2"></i> Load URL
            </button>
        </div>
        <div id="pdf-viewer-stage" class="pdf-viewer-stage" role="document" aria-label="PDF content area">
            <div class="pdf-viewer-empty-state">
                <p>Load a PDF from your device or paste a URL to view it here.</p>
            </div>
        </div>
    </div>

    <!-- Marker Popup -->
    <div id="marker-popup" class="marker-popup overlay-panel" aria-hidden="true" role="dialog" aria-label="Marker tools">
        <button id="marker-popup-close" class="floating-toggle floating-toggle--close" title="Close marker tools" aria-label="Close marker tools">
            <i data-lucide="x"></i>
        </button>
        <div class="marker-row">
            <label for="marker-domain">Domain:</label>
            <select id="marker-domain" class="glass-select marker-select">
                <option value="land">Land</option>
                <option value="air">Air</option>
                <option value="sea">Sea</option>
            </select>
        </div>

        <div class="marker-row">
            <label for="marker-type">Type:</label>
            <select id="marker-type" class="glass-select marker-select"></select>
        </div>

        <fieldset id="marker-identity-options">
            <legend>Select Identity</legend>
            <!-- Dynamically generated radio buttons go here -->
        </fieldset>
    </div>

    <!-- Export Popup -->
    <div id="export-popup" class="export-popup hidden">
        <div class="tool-group-header">Select layers to export</div>
        <div><label><input type="checkbox" id="export-whiteboard" checked> Whiteboard</label></div>
        <div><label><input type="checkbox" id="export-markers" checked> Markers</label></div>
        <div><label><input type="checkbox" id="export-bullseye" checked> Bullseye</label></div>
        <div class="export-button-row">
            <button id="confirm-export" class="button" title="Export layers">
                <i data-lucide="upload"></i> Export
            </button>
            <button id="cancel-export" class="button" title="Cancel">
                Cancel
            </button>
        </div>
    </div>



    <!-- Scripts -->
    <script src="bms-ini-loader-flat.js"></script>
    <script src="bms-airport-layer.js"></script>
    <script src="bms-ruler-tool.js"></script>
    <script src="bms-whiteboard.js"></script>
    <script src="bms-marker-layer.js"></script>
    <script src="bms-bullseye.js"></script>
    <script src="bms-export-import.js"></script>


    <script>
        let map, tileLayer;
        let currentTheater = 'Korea';
        let currentSettings = getTheaterSettings(currentTheater);
        const tileSize = 256;
        let dragPanInteraction = null;
        let isWhiteboardToolbarVisible = false;
        let isPdfViewerVisible = false;
        let activePdfObjectUrl = null;
        let pdfViewerInstance = null;
        window.getCurrentScale = () => currentSettings.scale;
        const controlWrapper = document.getElementById('control-wrapper');
        const toolbarToggle = document.getElementById('control-toggle');
        const toggleIcon = document.getElementById('control-toggle-icon');
        const toolbarOpenButton = document.getElementById('control-toggle-open');
        const whiteboardToolbar = document.getElementById('whiteboard-toolbar');
        const whiteboardToolbarToggleButton = document.getElementById('whiteboard-toolbar-toggle');
        const whiteboardToolbarCloseButton = document.getElementById('whiteboard-toolbar-close');
        const markerPopupCloseButton = document.getElementById('marker-popup-close');
        const embedPdfModulePromise = import('https://snippet.embedpdf.com/embedpdf.js')
            .then(mod => mod?.default ?? mod)
            .catch(error => {
                console.error('Failed to load EmbedPDF', error);
                return null;
            });

        const pdfViewerOverlay = document.getElementById('pdf-viewer-overlay');
        const pdfViewerToggleButton = document.getElementById('pdf-viewer-toggle');
        const pdfViewerCloseButton = document.getElementById('pdf-viewer-close');
        const pdfViewerStage = document.getElementById('pdf-viewer-stage');
        const pdfFileInput = document.getElementById('pdf-file-input');
        const pdfUrlInput = document.getElementById('pdf-url-input');
        const pdfLoadButton = document.getElementById('pdf-load-button');

        function adjustControlPanelForOverlays() {
            if (!controlWrapper) return;
            const overlayActive = isWhiteboardToolbarVisible || isMarkerMode || isPdfViewerVisible;
            const shouldHide = (window.innerWidth <= 1070 && overlayActive) || isPdfViewerVisible;
            controlWrapper.classList.toggle('hidden-for-overlay', shouldHide);
        }

        function showWhiteboardToolbar() {
            if (!whiteboardToolbar) return;
            whiteboardToolbar.classList.add('is-visible');
            whiteboardToolbar.setAttribute('aria-hidden', 'false');
            whiteboardToolbarToggleButton?.classList.add('active');
            whiteboardToolbarToggleButton?.setAttribute('aria-expanded', 'true');
            isWhiteboardToolbarVisible = true;
            adjustControlPanelForOverlays();
        }

        function hideWhiteboardToolbar() {
            if (!whiteboardToolbar) return;
            whiteboardToolbar.classList.remove('is-visible');
            whiteboardToolbar.setAttribute('aria-hidden', 'true');
            whiteboardToolbarToggleButton?.classList.remove('active');
            whiteboardToolbarToggleButton?.setAttribute('aria-expanded', 'false');
            isWhiteboardToolbarVisible = false;
            adjustControlPanelForOverlays();
        }

        function showPdfViewer() {
            if (!pdfViewerOverlay) return;
            pdfViewerOverlay.classList.add('is-visible');
            pdfViewerOverlay.setAttribute('aria-hidden', 'false');
            pdfViewerToggleButton?.classList.add('active');
            pdfViewerToggleButton?.setAttribute('aria-expanded', 'true');
            isPdfViewerVisible = true;
            adjustControlPanelForOverlays();
        }

        function hidePdfViewer() {
            if (!pdfViewerOverlay) return;
            pdfViewerOverlay.classList.remove('is-visible');
            pdfViewerOverlay.setAttribute('aria-hidden', 'true');
            pdfViewerToggleButton?.classList.remove('active');
            pdfViewerToggleButton?.setAttribute('aria-expanded', 'false');
            isPdfViewerVisible = false;
            adjustControlPanelForOverlays();
        }

        function clearPdfObjectUrl() {
            if (activePdfObjectUrl) {
                URL.revokeObjectURL(activePdfObjectUrl);
                activePdfObjectUrl = null;
            }
        }

        function resetPdfViewerStage() {
            if (!pdfViewerStage) return;
            pdfViewerInstance?.destroy?.();
            pdfViewerInstance = null;
            pdfViewerStage.innerHTML = `
                <div class="pdf-viewer-empty-state">
                    <p>Load a PDF from your device or paste a URL to view it here.</p>
                </div>
            `;
        }

        async function renderPdfViewer(source) {
            if (!pdfViewerStage) return;
            try {
                const EmbedPDF = await embedPdfModulePromise;
                if (!EmbedPDF) return;
                if (pdfViewerInstance && typeof pdfViewerInstance.destroy === 'function') {
                    pdfViewerInstance.destroy();
                }
                pdfViewerStage.innerHTML = '';
                pdfViewerInstance = EmbedPDF.init({
                    type: 'container',
                    target: pdfViewerStage,
                    src: source
                });
            } catch (error) {
                console.error('Failed to render PDF', error);
                resetPdfViewerStage();
            }
        }

        function setPdfViewerSource(source) {
            if (!source) {
                resetPdfViewerStage();
                return;
            }
            renderPdfViewer(source);
        }

        function loadPdfFromUrl() {
            const url = pdfUrlInput?.value.trim();
            if (!url) return;
            clearPdfObjectUrl();
            setPdfViewerSource(url);
            showPdfViewer();
        }

        window.showWhiteboardToolbar = showWhiteboardToolbar;
        window.hideWhiteboardToolbar = hideWhiteboardToolbar;
        window.isWhiteboardToolbarOpen = () => isWhiteboardToolbarVisible;

        hideWhiteboardToolbar();

        const mousePositionControl = new ol.control.MousePosition({
            coordinateFormat: coord => `X: ${coord[0].toFixed(0)}, Y: ${coord[1].toFixed(0)}`,
            className: 'custom-mouse-position',
            target: document.getElementById('mouse-position')
        });

        function deactivateAllTools() {
            // Disable ruler
            if (isRulerActive) {
                disableRuler(map, document.getElementById('ruler-button'));
            }

            // Disable marker
            if (isMarkerMode) {
                isMarkerMode = false;
                document.getElementById('marker-button').classList.remove('active');
                const markerPopup = document.getElementById('marker-popup');
                if (markerPopup) {
                    markerPopup.classList.remove('is-visible');
                    markerPopup.setAttribute('aria-hidden', 'true');
                }
                dragPanInteraction?.setActive(true);
                map.getTargetElement().style.cursor = '';
            }

            // Disable bullseye
            if (isBullseyeMode) {
                disableBullseyeMode(map);
            }

            // Deactivate whiteboard properly
            if (whiteboardDrawInteraction) {
                map.removeInteraction(whiteboardDrawInteraction);
                whiteboardDrawInteraction = null;
                whiteboardEnabled = false;
                dragPanInteraction?.setActive(true);
            }

            hideWhiteboardToolbar();
            hidePdfViewer();

            // Reset active UI buttons
            document.querySelectorAll('#control-bar .button').forEach(btn => btn.classList.remove('active'));
            adjustControlPanelForOverlays();
        }


        function getTheaterSettings(theater) {
            const settings = {
                Korea: { size: 16384, center: [8192, 8192], zoom: 2, scale: 0.004876, aip: 'aip_korea.json' },
                Israel: { size: 8192, center: [4096, 4096], zoom: 2, scale: 0.002438, aip: 'aip_israel.json' },
                Balkans: { size: 16384, center: [8192, 8192], zoom: 2, scale: 0.004876, aip: 'aip_balkans.json'}
            };
            return settings[theater] || settings.Korea;
        }

        function getResolutions(size) {
            return Array.from({ length: 7 }, (_, z) => size / tileSize / 2 ** z);
        }

        function createTileLayer(theater, projection, resolutions) {
            return new ol.layer.Tile({
                source: new ol.source.XYZ({
                    projection,
                    tileGrid: new ol.tilegrid.TileGrid({
                        extent: [0, 0, projection.getExtent()[2], projection.getExtent()[3]],
                        origin: [0, projection.getExtent()[3]],
                        tileSize,
                        resolutions
                    }),
                    tileUrlFunction: ([z, x, y]) =>
                        `${theater}/${z}/${x}/${Math.pow(2, z) - y - 1}.png`
                }),
                maxZoom: 7
            });
        }

        function initMap(theater) {
            const settings = getTheaterSettings(theater);
            currentSettings = settings;

            const projection = new ol.proj.Projection({
                code: 'FALCON_PIXELS',
                units: 'pixels',
                extent: [0, 0, settings.size, settings.size]
            });

            const resolutions = getResolutions(settings.size);
            mousePositionControl.setProjection(projection);

            tileLayer = createTileLayer(theater, projection, resolutions);

            map = new ol.Map({
                target: 'map',
                layers: [tileLayer],
                controls: ol.control.defaults.defaults().extend([mousePositionControl]),
                view: new ol.View({
                    projection,
                    center: settings.center,
                    zoom: settings.zoom,
                    resolutions,
                    constrainRotation: true,
                    extent: projection.getExtent()
                })
            });

            dragPanInteraction = map.getInteractions().getArray().find(i => i instanceof ol.interaction.DragPan);

            // Remove rotation
            map.getInteractions().forEach(interaction => {
                if (interaction instanceof ol.interaction.PinchRotate || interaction instanceof ol.interaction.DragRotate) {
                    map.removeInteraction(interaction);
                }
            });

           
            if (currentSettings.aip) {
                loadAirportIcons(`${theater}/${currentSettings.aip}`, map);
            }
            
            // Init tools
            addINILoaderUI(map);

            const bullseyeCenter = currentSettings.center; // or any other coordinates
            drawBullseye(map, bullseyeCenter);

            initWhiteboard(map);
            initMarkerTool(map);
        }

        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
            initMap(currentTheater);
        });

        // Event: Switch Theater
        document.getElementById('theater-select').addEventListener('change', e => {
            currentTheater = e.target.value;
            map.setTarget(null);
            document.getElementById('map').innerHTML = '';
            initMap(currentTheater);
        });

        // Ruler
        document.getElementById('ruler-button').addEventListener('click', () => {
            const isNowActive = !isRulerActive;
            deactivateAllTools();
            if (isNowActive) enableRuler(map, document.getElementById('ruler-button'));
        });

        // Marker toggle
        document.getElementById('marker-button').addEventListener('click', () => {
            const wasActive = isMarkerMode;
            deactivateAllTools();
            if (!wasActive) {
                isMarkerMode = true;
                const markerBtn = document.getElementById('marker-button');
                markerBtn.classList.add('active');
                const markerPopup = document.getElementById('marker-popup');
                if (markerPopup) {
                    markerPopup.classList.add('is-visible');
                    markerPopup.setAttribute('aria-hidden', 'false');
                }
                map.getTargetElement().style.cursor = 'crosshair';
                //dragPanInteraction?.setActive(false);
                adjustControlPanelForOverlays();
            }
        });

        // Bullseye toggle
        document.getElementById('bullseye-button').addEventListener('click', () => {
            const wasActive = isBullseyeMode;
            deactivateAllTools();
            if (!wasActive) enableBullseyeMode(map);
        });

        whiteboardToolbarToggleButton?.addEventListener('click', () => {
            const shouldShow = !isWhiteboardToolbarVisible;
            deactivateAllTools();
            if (shouldShow) {
                showWhiteboardToolbar();
            }
        });

        whiteboardToolbarCloseButton?.addEventListener('click', () => {
            deactivateAllTools();
        });

        markerPopupCloseButton?.addEventListener('click', () => {
            deactivateAllTools();
        });

        pdfViewerToggleButton?.addEventListener('click', () => {
            const shouldShow = !isPdfViewerVisible;
            deactivateAllTools();
            if (shouldShow) {
                showPdfViewer();
            }
        });

        pdfViewerCloseButton?.addEventListener('click', () => {
            hidePdfViewer();
        });

        pdfLoadButton?.addEventListener('click', loadPdfFromUrl);

        pdfUrlInput?.addEventListener('keydown', event => {
            if (event.key === 'Enter') {
                event.preventDefault();
                loadPdfFromUrl();
            }
        });

        pdfFileInput?.addEventListener('change', event => {
            const file = event.target.files?.[0];
            if (!file) return;
            clearPdfObjectUrl();
            activePdfObjectUrl = URL.createObjectURL(file);
            setPdfViewerSource(activePdfObjectUrl);
            showPdfViewer();
            event.target.value = '';
        });

        window.addEventListener('beforeunload', () => {
            clearPdfObjectUrl();
        });

        // Clear loaded mission
        document.getElementById('clear-button').addEventListener('click', () => {
            if (flightPathLayer) {
                map.removeLayer(flightPathLayer);
                flightPathLayer = null;
            }
        });

        // Undo/Redo
        document.getElementById('whiteboard-undo')?.addEventListener('click', () => {
            const f = undoStack.pop();
            if (f) whiteboardSource.removeFeature(f), redoStack.push(f);
        });

        document.getElementById('whiteboard-redo')?.addEventListener('click', () => {
            const f = redoStack.pop();
            if (f) whiteboardSource.addFeature(f), undoStack.push(f);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (/input|textarea/i.test(e.target.tagName)) return;

                const shortcuts = {
                    q: 'whiteboard-pencil',
                    w: 'whiteboard-polygon',
                    e: 'whiteboard-circle',
                    r: 'whiteboard-rect',
                    t: 'whiteboard-text',
                    c: 'whiteboard-eraser',
                    l: 'ruler-button',
                    z: 'whiteboard-undo',
                    y: 'whiteboard-redo'
                };

            const id = shortcuts[e.key.toLowerCase()];
            if (id) document.getElementById(id)?.click();
        });

        // Touch handling
        document.addEventListener('touchmove', e => {
            if (isRulerActive) e.preventDefault();
        }, { passive: false });

        // Prevent double-tap zoom on UI controls while keeping map zoom intact
        let lastUITapTime = 0;
        document.addEventListener('touchend', event => {
            if (event.target.closest('#map')) {
                lastUITapTime = 0;
                return;
            }
            const currentTime = Date.now();
            if (currentTime - lastUITapTime < 350) {
                event.preventDefault();
            }
            lastUITapTime = currentTime;
        }, { passive: false });

        function positionToolbarPopup(popupEl, triggerEl, options = {}) {
            if (!popupEl || !controlWrapper) return;
            const offsetX = options.offsetX ?? 16;
            const offsetY = options.offsetY ?? 0;
            const verticalAlign = options.verticalAlign ?? 'trigger-middle';
            const margin = options.margin ?? 12;

            const toolbarRect = controlWrapper.getBoundingClientRect();
            const anchorRect = triggerEl ? triggerEl.getBoundingClientRect() : toolbarRect;
            const popupRect = popupEl.getBoundingClientRect();

            let top;
            switch (verticalAlign) {
                case 'toolbar-top':
                    top = toolbarRect.top;
                    break;
                case 'trigger-top':
                    top = anchorRect.top;
                    break;
                default:
                    top = anchorRect.top + (anchorRect.height / 2) - (popupRect.height / 2);
            }
            top += offsetY;
            top = Math.max(margin, Math.min(window.innerHeight - popupRect.height - margin, top));

            const left = toolbarRect.right + offsetX;

            popupEl.style.position = 'fixed';
            popupEl.style.top = `${top}px`;
            popupEl.style.left = `${left}px`;
        }

        window.positionToolbarPopup = positionToolbarPopup;

        function updateToolbarState(collapsed) {
            if (!controlWrapper || !toolbarToggle || !toggleIcon) return;
            const isCurrentlyCollapsed = controlWrapper.classList.contains('collapsed');
            if (collapsed === isCurrentlyCollapsed) return;
            toolbarToggle.setAttribute('aria-expanded', String(!collapsed));
            controlWrapper.classList.toggle('collapsed', collapsed);
            toggleIcon.setAttribute('data-lucide', 'x');
            lucide.createIcons();
            if (toolbarOpenButton) {
                toolbarOpenButton.classList.toggle('visible', collapsed);
                toolbarOpenButton.setAttribute('aria-expanded', String(collapsed));
            }
            if (collapsed) {
                deactivateAllTools();
                const exportPopup = document.getElementById('export-popup');
                if (exportPopup) {
                    exportPopup.classList.add('hidden');
                    exportPopup.style.visibility = '';
                }
            }
        }

        toolbarToggle?.addEventListener('click', () => {
            const collapsed = controlWrapper?.classList.contains('collapsed') ?? false;
            updateToolbarState(!collapsed);
        });

        toolbarOpenButton?.addEventListener('click', () => {
            updateToolbarState(false);
        });

        // Allow ESC to hide toolbar
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !(controlWrapper?.classList.contains('collapsed'))) {
                updateToolbarState(true);
            }
        });

        window.addEventListener('resize', () => {
            const exportPopup = document.getElementById('export-popup');
            if (exportPopup && !exportPopup.classList.contains('hidden')) {
                positionToolbarPopup(exportPopup, document.getElementById('export-layers'), { verticalAlign: 'trigger-middle' });
            }
            adjustControlPanelForOverlays();
        });



    </script>
</body>

</html>
